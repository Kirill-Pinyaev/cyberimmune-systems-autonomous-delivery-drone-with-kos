# Документация модуля Flight Controller (Контроллер полета)

## Общее описание

Модуль Flight Controller является ключевым компонентом системы безопасности дрона, который:

1. Управляет выполнением полетных миссий
2. Обеспечивает соблюдение протоколов безопасности
3. Осуществляет связь с сервером ОРВД (ОРган Воздушного Движения)
4. Реализует несколько важных функций безопасности

## Основные компоненты

### Управление миссиями

Система поддерживает несколько типов команд:

1. **Основные команды навигации**:
   - `HOME` - Установка домашней позиции (должна быть первой)
   - `TAKEOFF` - Взлет на заданную высоту
   - `WAYPOINT` - Точка маршрута
   - `LAND` - Команда посадки

2. **Специальные операции**:
   - `INTEREST` - Точки с RFID-сканированием
   - `SET_SERVO` - Управление сервоприводами
   - `DELAY` - Пауза в выполнении миссии

### Системы безопасности

1. **Защита от полета в запретных зонах**:
   - Динамическая загрузка ограниченных зон
   - Автоматический пересчет маршрута
   - Проверка хэшей данных зон

2. **Аварийные процедуры**:
   - Мгновенное отключение моторов
   - Аварийная посадка
   - Обработка потери связи

3. **Безопасность груза**:
   - Авторизация сброса по местоположению
   - Контроль питания механизмов сброса
   - Проверка точек сброса

## Основные функции

### Работа с миссиями

- `parseCommands()` - Разбор строки миссии на команды
- `missionToBytes()` - Конвертация в формат автопилота
- `loadMission()` - Загрузка и проверка миссий

### Функции безопасности

- `initCargoProtection()` - Настройка точек сброса
- `onServoCommandRequested()` - Контроль сброса груза
- `monitorInterestPoints()` - Обработка RFID-сканирования

### Управление полетом

- `pauseFlight()`/`resumeFlight()` - Приостановка/возобновление
- `changeWaypoint()` - Корректировка маршрута
- `setKillSwitch()` - Аварийное отключение

## Примеры использования

### Выполнение миссии

```cpp
// Загрузка миссии
if (loadMission(missionString)) {
    // Конвертация
    uint8_t missionBytes[1024];
    missionToBytes(commands, commandNum, missionBytes);
    
    // Запуск
    setMission(missionBytes, getMissionBytesSize(...));
}
```

### Обработка точек интереса

```cpp
void monitorInterestPoints() {
    // Проверка дистанции
    if (distance <= threshold) {
        pauseFlight(); // Посадка
        scanRfid(scanResult); // Сканирование
        resumeFlight(); // Продолжение
    }
}
```

### Безопасность груза

```cpp
void onServoCommandRequested(int channel, int pwm) {
    if (channel == CARGO_SERVO) {
        // Проверка местоположения
        if (isAuthorizedDropLocation(...)) {
            setCargoLock(1); // Включение
            // Сброс...
            setCargoLock(0); // Выключение
        }
    }
}
```

## Потоки выполнения

Система использует несколько параллельных потоков:

1. Сессии ping - поддержка связи
2. Проверка обновлений - мониторинг статуса
3. Логгер координат - отслеживание позиции  
4. Контроль скорости
5. Коррекция пути
6. Мониторинг точек интереса

## Обработка ошибок

Система включает:
- Проверку команд
- Верификацию координат
- Аутентификацию подписей
- Восстановление связи
- Аварийные процедуры

## Важные константы

- `INTEREST_POINT_THRESHOLD` - 10см (дистанция сканирования)
- `CARGO_UNLOCK_RADIUS_M` - Допуск точки сброса
- `RETRY_DELAY_SEC` - 1с (интервал переподключения)
- `COMMAND_MAX_STRING_LEN` - 32 (макс. длина команды)

## Зависимости

- mbedTLS (хэширование)
- Стандартные библиотеки C
- Система IPC-сообщений
- Интерфейс навигации
- Коннектор автопилота

Документация дает общее представление. Для деталей реализации см. заголовочные файлы и комментарии в коде.